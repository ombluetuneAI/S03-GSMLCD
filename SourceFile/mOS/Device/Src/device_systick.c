/*********************************************************************************
*文件名     : device_systick.c
*作用       : 系统节拍
*原理       : 
*******************************************************************************/



#include "sys.h"
#include "system.h"

extern void KeySystick100Routine(void);

extern void TimerSystick1000Routine(void);

extern void UsartSystick1000Routine(void);

//extern void AdcSystick10000Routine(void);

extern void WirelessSystick100Routine(void);

extern void SysTick_Handler(void);

extern void InitSystick(void);

extern void DTMFSystick1000Routine(void);

extern void SendMessageSystick100Routine(void);

extern void CallMessageSystick100Routine(void);

extern void CallRingSystick1000Routine(void);

void CidMessageSystick100Routine(void);
	

extern u8 RTCGetTime(void);//更新时间 ;
extern void DateSystick1000Routine(void);
extern void Sim800SystickRoutine(void);

extern __IO int32_t OS_TimeMS;

#define Systick10000Sum 2
#define Systick1000Sum  4
#define Systick100Sum   10

static void Dummy(void) {};

static function Systick10000RegisterPointerBlock[Systick10000Sum] =
{
    Dummy, Dummy
};

static function Systick1000RegisterPointerBlock[Systick1000Sum] =
{
    Dummy, Dummy, Dummy, Dummy
};

static function Systick100RegisterPointerBlock[Systick100Sum] =
{
    Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy
};

/*******************************************************************************
* 描述	    : 系统节拍注册函数，用于注册回调函数到不同速度的系统节拍数组中。
* 输入参数  : systemTick 系统节拍速度类型 registerFunction 注册的函数指针
* 返回参数  : bool布尔变量，返回是否成功
*******************************************************************************/
static bool RegisterSystick(SystickEnum type, function registerFunction)
{
    static byte Systick100Counter = 0;
    static byte Systick1000Counter = 0;
    static byte Systick10000Counter = 0;

    switch(type)
    {
        case Systick100:
            if (Systick100Counter == Systick100Sum) return(false);
            Systick100RegisterPointerBlock[Systick100Counter++] = registerFunction;  
            return(true);
        case Systick1000:
            if (Systick1000Counter == Systick1000Sum) return(false);
            Systick1000RegisterPointerBlock[Systick1000Counter++] = registerFunction;   
            return(true);
        case Systick10000:
            if (Systick10000Counter == Systick10000Sum) return(false);
            Systick10000RegisterPointerBlock[Systick10000Counter++] = registerFunction;   
            return(true);
        default:
            return(false);
    }
}
/*******************************************************************************
* 描述	    : 系统节拍中断入口，非常重要，每秒10000次，即0.1mS一次
*           : 系统节拍通过switch细分为每秒1000次，每秒100次的例行节拍
*           : 同层直接调用，高层采用注册调用
*******************************************************************************/
u32 SystemRunTime=0;
void SysTick_Handler(void)
{
  byte div;
  static byte Counter = 0;
//	static byte keyTimes=0;
  if(++Counter == 100) Counter = 0;	
//	Sim800SystickRoutine();
	//DateSystick1000Routine();
    //Systick10000RegisterPointerBlock[0]();
    //Systick10000RegisterPointerBlock[1]();
    //OS_TimeMS ++;
	
    div = Counter / 10;
    switch(Counter % 10)
    {
        case 0:
          SystemRunTime++;  
//            AdcSystick10000Routine();
            break;
        case 1:
            Systick1000RegisterPointerBlock[1]();
            break;
        case 2:
            Systick1000RegisterPointerBlock[2]();
            break;
        case 3:
            Systick1000RegisterPointerBlock[3]();
            break;
        case 4:
            UsartSystick1000Routine();
            break;
        case 5:
            TimerSystick1000Routine();
            break;
        case 6:
			CallMessageSystick100Routine();
			CidMessageSystick100Routine();
            break;
        case 7:
//						DateSystick1000Routine();
            SendMessageSystick100Routine();
            break;
        case 8:
            Systick100RegisterPointerBlock[div]();
            break;
        case 9:
		switch(div)//1ms执行一次，下面的每一项10ms执行一次
		{
//			case 0:
//				
//				break;
//			case 1:
//				if(++keyTimes>=5)
//				{
//					keyTimes=0;
//					KeySystick100Routine();
//				}
//				break;
			case 0:
				DTMFSystick1000Routine();
				break;
			case 1:
        CallRingSystick1000Routine();
				break;
			case 2:
        Sim800SystickRoutine();
				break;
			default:
				break;
		}
		break;
    }
	//WirelessSystick100Routine();	
}

void InitSystick(void)
{
    System.Device.Systick.Register = RegisterSystick;
    SysTick_Config(SystemCoreClock / 10000);
}



